micronaut:
  application:
    name: querygate
  server:
    port: 8080
    thread-selection: AUTO
  metrics:
    enabled: true
    export:
      prometheus:
        enabled: true
        descriptions: true
        step: PT1M
  security:
    enabled: ${GATEWAY_SECURITY_ENABLED:true}
    intercept-url-map:
      - pattern: /health
        access:
          - isAnonymous()
      - pattern: /prometheus
        access:
          - isAnonymous()
      - pattern: /metrics/**
        access:
          - isAnonymous()
    token:
      enabled: true

# Datasource configuration (HikariCP)
datasources:
  default:
    url: "jdbc:h2:mem:devDb;LOCK_TIMEOUT=10000;DB_CLOSE_ON_EXIT=FALSE"
    driver-class-name: org.h2.Driver
    username: sa
    password: ""
    pool-name: HikariPool-Gateway
    maximum-pool-size: 20
    minimum-idle: 5
    connection-timeout: 30000
    idle-timeout: 600000
    max-lifetime: 1800000
    leak-detection-threshold: 60000

# Gateway-specific configuration
gateway:
  # External MyBatis mapper location
  mybatis:
    mapper-locations: ${GATEWAY_MAPPER_PATH:./config/mappers}
    cache-enabled: false
    lazy-loading-enabled: false
    default-statement-timeout: 30

  # External endpoint configuration file
  endpoint-config-path: ${GATEWAY_ENDPOINT_CONFIG:./config/endpoint-config.yml}

  # Hot reload settings - disabled by default for security
  # Enable only in development with GATEWAY_HOT_RELOAD=true
  hot-reload:
    enabled: ${GATEWAY_HOT_RELOAD:false}
    poll-interval-ms: 5000

  # SQL logging - parameter logging disabled by default to prevent sensitive data in logs
  sql-logging:
    enabled: true
    log-parameters: ${GATEWAY_SQL_LOG_PARAMS:false}
    log-timing: true
    slow-query-threshold-ms: 1000

  # Virtual thread configuration
  virtual-threads:
    enabled: true
    executor-name: gateway-virtual-executor

  # Security configuration
  security:
    enabled: ${GATEWAY_SECURITY_ENABLED:true}
    api-key-header: X-API-Key
    api-keys: ${GATEWAY_API_KEYS:}
    allowed-networks:
      - 127.0.0.1
      - "::1"

  # Backpressure configuration
  backpressure:
    enabled: true
    max-concurrent-requests: ${GATEWAY_MAX_CONCURRENT:100}
    request-timeout-ms: 30000
    statement-timeout-seconds: 30

# Logging configuration - INFO by default, use env vars for DEBUG
logger:
  levels:
    querygate: ${GATEWAY_LOG_LEVEL:INFO}
    querygate.interceptor: ${GATEWAY_LOG_LEVEL:INFO}
    SQL_LOGGER: ${GATEWAY_SQL_LOG_LEVEL:INFO}
    org.apache.ibatis: INFO
    com.zaxxer.hikari: INFO
